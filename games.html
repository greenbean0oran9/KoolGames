<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KoolGames â€“ Games</title>
<style>
body { background:black; color:white; font-family:Arial; margin:0 }
#topBar {
  height:60px; border-bottom:2px solid white;
  display:flex; justify-content:space-between; align-items:center;
  padding:0 20px;
}
#main { padding:20px; max-width:900px; margin:auto }
.game { border:2px solid white; border-radius:16px; padding:14px; margin-bottom:12px }
button { border-radius:999px; padding:8px 18px; border:2px solid white }
</style>
</head>

<body>
<div id="topBar">
  <div>KoolGames</div>
  <div>
    <span id="username"></span>
    <button onclick="openUpload()">Upload</button>
  </div>
</div>

<div id="main">
  <h2>Community Games</h2>
  <div id="games"></div>
</div>

<input id="files" type="file" multiple hidden>
<input id="title" placeholder="Game title" hidden>

<script src="emoji-preset.js"></script>

<script type="module">
import { db, storage } from "./firebase.js";
import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const user = localStorage.getItem("currentUser");
if (!user) location.href = "index.html";
document.getElementById("username").innerHTML = parseEmojis(user);

const gamesDiv = document.getElementById("games");

async function loadGames() {
  gamesDiv.innerHTML = "";
  const snap = await getDocs(collection(db, "games"));
  snap.forEach(doc => {
    const g = doc.data();
    gamesDiv.innerHTML += `
      <div class="game">
        <b>${parseEmojis(g.title)}</b><br>
        by ${parseEmojis(g.user)}<br><br>
        <button onclick="play('${doc.id}')">Play</button>
      </div>`;
  });
}

window.openUpload = () => {
  const title = prompt("Game title?");
  if (!title) return;
  document.getElementById("files").onchange = e => upload(title, e.target.files);
  document.getElementById("files").click();
};

async function upload(title, files) {
  const uploaded = [];
  for (const file of files) {
    const r = ref(storage, `games/${Date.now()}_${file.name}`);
    await uploadBytes(r, file);
    uploaded.push({ name:file.name, url: await getDownloadURL(r) });
  }

  await addDoc(collection(db,"games"), {
    title,
    user,
    files: uploaded
  });

  loadGames();
}

window.play = async (id) => {
  location.href = `run.html?id=${id}`;
};

loadGames();
</script>
</body>
</html>
